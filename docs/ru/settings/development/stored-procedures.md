
<!-- ---
title: 'Мини-приложения | Панель управления | Разработка | Хранимые процедуры'
is_hidden: false
is_search_available: true
menu: 'main_menu'
visible_to_search_robots: true
meta_description: 
redirect_to: 
lang: ru
--- -->

# Хранимые процедуры (настройки мини-приложений)

Хранимые процедуры — функции на языке [VKScript](method/execute), код которых хранится в настройках мини-приложения, а выполняется на стороне серверов ВКонтакте.

Хранимые процедуры — мощный инструмент для работы с данными.

* Каждая процедура может выполнять один или несколько API-запросов. При этом результаты выполнения отдельных запросов не передаются на компьютер пользователя, что в общем случае ускоряет выполнение и экономит трафик. Последнее особенно важно для мини-приложений, которые работают в мобильных приложениях ВКонтакте для Android и iOS.

* Для работы хранимых процедур не требуется сервер мини-приложения. То есть вы можете вынести часть бизнес-логики из серверного кода, тем самым упростив его.

В разделе настроек **Хранимые процедуры** вы можете создавать, проверять, редактировать и удалять хранимые процедуры для вашего мини-приложения.

## Как открыть

[Откройте панель управления мини-приложением](mini-apps/settings/overview) и в меню слева выберите **Разработка**&nbsp;&rarr; **Хранимые процедуры**.

<!--
## Как выглядит

Внешний вид раздела зависит от того, используете ли вы уже хранимые процедуры или нет.

<!-- exclusions/_images/mini-apps/settings/development/stored-procs/stored-procedures-no-procs.png 
<!-- exclusions/_images/mini-apps/settings/development/stored-procs/stored-procedures-proc-list.png 
:::carousel
![alt=Внешний вид раздела, когда у вас ещё нет хранимых процедур;title=Внешний вид раздела, когда у вас ещё нет хранимых процедур](200cc457286133edba4264fc94d4de66e823eb215fbce25e1166068b "-7067552548256376737")
![alt=Список созданных хранимых процедур;title=Список созданных хранимых процедур](fb0aff902643af4f3fe5085c4e00e3cd7ca4ea750d80b73fcd142366 "-7524062042023835993")
:::

-->

## Кому доступно

Раздел доступен [администраторам](mini-apps/settings/managers) мини-приложения со следующими правами:

* Создатель мини-приложения.

* Администратор с полным доступом.

* Администратор с частичным доступом, с правом «Редактирование».

## Действия в разделе

### Создать процедуру

1. Нажмите **Добавить процедуру**.

    Откроется экран редактирования процедуры.
    <!-- exclusions/_images/mini-apps/settings/stored-procs/development/stored-procedures-edit.png -->
    ![alt=Пример экрана редактирования процедуры;title=Пример экрана редактирования процедуры](663d4255afe92e3078338c77702760c450666e690230d1f067d45503 "4471073398002463623")

1. На экране редактирования:

    * Укажите **Название процедуры** — строку от 1 до 100 символов. Допустимы только символы латинского алфавита.

        Поле содержит ключевое слово `execute.` для напоминания о том, как процедура будет вызываться в коде. Это слово не является частью имени процедуры.

    * В поле **Версия API** укажите версию API ВКонтакте, которая будет использована для вызова API-запросов из процедуры.

        Параметры и возвращаемые значения API-запросов могут меняться от версии к версии. С помощью этого поля вы можете указать ожидаемую версию, чтобы избежать возможных проблем.

    * Введите код процедуры. Подробности синтаксиса — в разделе [Формат языка VKScript](method/execute). Некоторые ключевые особенности описаны [ниже](#Где%20почитать%20про%20VKScript).

1. Чтобы проверить, как работает код, нажмите **Запустить**. Результат отобразится под текстовым полем для ввода кода.

    Перед выполнением процедуры платформа проверит синтаксис её кода и сообщит о первой найденной ошибке. Исправьте ошибки синтаксиса до сохранения процедуры.

    Подробнее о тестовых запусках рассказано [ниже](#Выполнить%20тестовый%20запуск).

1. Когда всё будет готово, нажмите **Сохранить**.

    > Если в коде есть синтаксические ошибки, сохранить его не получится. Сначала исправьте ошибки.

### Найти и отредактировать процедуру

1. Чтобы найти процедуру в списке, в поле поиска введите несколько символов из её имени. Регистр символов — заглавные или прописные — не важен.

    ВКонтакте отобразит те хранимые процедуры, название которых содержит введённую строку.

1. Нажмите **Редактировать процедуру** для нужной процедуры. Откроется экран редактирования.

1. Внесите изменения и нажмите **Сохранить**.

    Чтобы выйти без сохранения, нажмите **Вернуться назад** в правом верхнем углу экрана. В этом случае все изменения будут отклонены.

### Где почитать про VKScript

Смотрите раздел [Формат языка VKScript](method/execute).

Некоторые ключевые особенности:

| Особенность ||
| --- | --- |
| Доступ к параметрам хранимой процедуры | `Args.param_name` |
| Вызов API-запросов | `var r = API.users.get( {"user_ids": 123} );`&#x0d;&#x0a;&#x0d;&#x0a;Здесь `users.get` — название группы и имя API-метода, как они указаны в [документации](reference). |
| Доступ к результатам запроса | `r@.field_name` |
| Вернуть значение и выйти из процедуры | `return { "result": 12345};` |
| Создание функций внутри процедуры | Не поддерживается. |

### Указать параметры

Параметры хранимой процедуры указываются при её [вызове](#Выполнить%20процедуру). Объявлять их в редакторе процедуры не нужно.

Чтобы обратиться к параметру, используйте синтаксис `Args.param-name`.

### Выполнить тестовый запуск

Нажмите **Запустить**. Результат выполнения отобразится в поле **Результат**. Оно содержит данные в том виде, в котором они будут переданы в код вызова процедуры.

<!-- exclusions/_images/mini-apps/settings//stored-procs/development/stored-procedures-results.png -->
![alt=Кнопка «Запустить» и результат выполнения;title=Кнопка «Запустить» и результат выполнения](557358bd8f49c8f49ba842355225e9f96e5de7ac5c2a8ce1116fca01 "-1303590112152395383")

Если при выполнении кода произошла ошибка, её описание отобразится в поле **Результат**.

<!-- exclusions/_images/mini-apps/settings/stored-procs/development/stored-procedures-error-in-results.webp -->
![alt=Пример ответа с информацией об ошибке;title=Пример ответа с информацией об ошибке](3c40492916007bf6d25d490044a140c6e23d51b7a4675ab9c2d0cf0c "-6776004390926932398")

Перед запуском платформа проверяет синтаксис кода процедуры. Код с синтаксическими ошибками выполнить не получится.

Платформа информирует о первой найденной синтаксической ошибке: показывает строку с описанием ошибки и номером строки в коде.

<!-- exclusions/_images/mini-apps/settings/stored-procs/development/stored-procedures-syntax-error.webp -->
![alt=Пример сообщения о синтаксической ошибке;title=Пример сообщения о синтаксической ошибке](f9ecd74ea6f88807b3b4529455a513795b611e6932288cbab3d3b04b "-8497654835837300940")

### Выполнить процедуру

Чтобы выполнить процедуру, вызовите API-метод [`execute`](method/execute). В вызов передайте название и параметры процедуры.

```
POST https://api.vk.ru/method/execute.ИМЯ-ПРОЦЕДУРЫ?access_token=КЛЮЧ-ДОСТУПА&v=ВЕРСИЯ-API&func_v=ВЕРСИЯ-ПРОЦЕДУРЫ&ПАРАМЕТР-1=ЗНАЧЕНИЕ-1&ПАРАМЕТР-2=ЗНАЧЕНИЕ-2 HTTP/1.1
```

Хранимую процедуру можно вызвать с помощью события [`VKWebAppCallAPIMethod`](bridge/VKWebAppCallAPIMethod).

```JavaScript
bridge.send("VKWebAppCallAPIMethod", {
  method: "execute.ИМЯ-ПРОЦЕДУРЫ",
  params: {
    ПАРАМЕТР-1: "ЗНАЧЕНИЕ-1",
    ПАРАМЕТР-2: "ЗНАЧЕНИЕ-2",
    v: "ВЕРСИЯ-API", // Например, "5.134"
    func_v: "ВЕРСИЯ-ПРОЦЕДУРЫ", // Например, "Версия 1"
    access_token: "КЛЮЧ-ДОСТУПА"
  }
});
```

### Создать новую версию процедуры

Вы можете создать несколько версий хранимой процедуры. Механизм версионирования помогает поддерживать работоспособность мини-приложения при изменении процедуры.

Инициировать выполнение процедуры можно из серверного кода и из кода, который работает на клиентской стороне. При этом возможна ситуация, когда код на клиентской стороне не будет совместим с новым кодом процедуры. В таком случае вы можете создать новую версию процедуры и использовать её в обновлённом клиентском коде, в то время как старый код будет работать со старой версией.

Чтобы создать новую версию хранимой процедуры:

1. Откройте процедуру для редактирования.

1. В выпадающем списке **Версия** выберите версию, которую вы хотите клонировать.

1. В этом же выпадающем списке нажмите **Добавить новую версию**. ВКонтакте создаст новую версию процедуры на основе выбранной.

    > Пункт «Добавить новую версию» появляется в списке после того, как вы сохраните процедуру в первый раз.

    <!-- exclusions/_images/mini-apps/settings/stored-procs/development/stored-procedures-create-new-version.png -->
    ![alt=Создание новой версии хранимой процедуры;title=Создание новой версии хранимой процедуры](e5c3adcebcad76d3391b2f391eac3bb30c6a73c20f698944a119eb4e "5651481461052262835")

1. Введите код новой версии и сохраните изменения.

    > Чтобы сохранить изменения, внесите хотя бы минимальные изменения в код. Сохранить код без изменений не получится.

### Удалить процедуру

1. Откройте хранимую процедуру для редактирования.

1. Нажмите **Версия процедуры** и выберите первую версию в списке.

1. В правом нижнем углу нажмите **Удалить**, затем подтвердите действие.

    <!-- exclusions/_images/mini-apps/settings/stored-procs/development/stored-procedures-delete-procedure.png -->
    ![alt=Удаление процедуры;title=Удаление процедуры](d459548e50b7df8f0751c6bef267e6eaf80fee258cf432c92831a0cc "-807133231084607119")

:::note
Если у процедуры несколько версий, при удалении первой будут удалены все версии.
:::

### Удалить версию процедуры

1. Откройте хранимую процедуру для редактирования.

1. Нажмите **Версия процедуры** и выберите версию из списка.

1. В правом нижнем углу нажмите **Удалить версию**.

    <!-- exclusions/_images/mini-apps/settings/development/stored-procs/stored-procedures-delete-version.png -->
    ![alt=Удаление версии;title=Удаление версии](9b11c9739f07c276ecd0e8caa0d60a20a1933bbcd78b90fa3fbefdaf "913919229506847032")

> Удалить первую версию процедуры нельзя. Она удаляется только вместе со всей процедурой.

## Материалы по теме

* [Мини-приложения — Панель управления](mini-apps/settings/overview)

* [Формат языка VKScript](method/execute)

* [Видеокурс. Эффективная работа с API ВКонтакте](mini-apps/learning/course/4-development/19-effective-work-with-api)

<!-- * [Хранимые процедуры](TO_DO#mini-apps/development/stored-procedures) -->
